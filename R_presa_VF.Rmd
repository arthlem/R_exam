---
title: "Présentation R: Online Retail"
author: "Arthur Lemoine, François Somville, Alexandre Antippas"
date: "Janvier 2019"
output:
  ioslides_presentation
fontsize: 11pt
geometry: margin=1cm
---


<style>
  h1{
  margin: 0
  }
</style>


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
chooseCRANmirror(graphics=FALSE, ind=1)
pkgs <- c("ggplot2","dplyr","lubridate","ade4","tm","SnowballC","wordcloud","cluster","factoextra","NbClust","gridExtra")
#install.packages(pkgs)
library(dplyr)
library(ggplot2)
library(data.table)
library(lubridate)
library(ade4)
library(tm)
library(SnowballC)
library(wordcloud)
library(cluster)
library(factoextra)
library(NbClust)
library(gridExtra)
```

```{r load myData, include=FALSE}
load("data.RData")
```

## Plan
1. Analyse des données importées
2. Nettoyage des données
3. Statistiques descriptives
4. Analyse des composantes principales (ACP)
5. Clustering
6. Bonus: Wordcloud

## 1. Analyse des données importées

### Introduction
Le dataset contient toutes les ventes émises par un magasin en ligne basé au Royaume-Uni. Le magasin vend des cadeaux uniques pour toutes les occasions.

### 8 variables
<font size="4"> 
1. <b>InvoiceNo:</b> Contient le numéro de la facture <br>
2. <b>StockCode:</b> Numéro d'identification du produit (C indique une annulation)<br>
3. <b>Description:</b> Description du produit<br>
4. <b>Quantity:</b> Quanitités de pièces commandé<br>
5. <b>InvoiceDate:</b> Date de la facture avec l'heure<br>
6. <b>UnitPrice:</b> Prix de l'unité en livre sterling<br>
7. <b>CustomerID:</b> ID du client (NA lors de modification de stock)<br>
8. <b>Country:</b> Pays destinataire<br> </font size>

## 1. Analyse des données importées
### Source:
```{r comment=NA}
cat("Source: https://archive.ics.uci.edu/ml/datasets/Online+Retail")
```


### Période:
```{r comment=NA}
cat("Du",as.character(head(select(onlineRetail, InvoiceDate), 1)[[1]]), "au", as.character(tail(select(onlineRetail, InvoiceDate), 1)[[1]]))
```

### Taille:
```{r comment=NA}
cat(nrow(onlineRetail), "lignes dans le dataset")
```

## 2. Nettoyage des données
### a. Données non pertinentes
<font size="4"> 
1. <b>C:</b> Annulation<br>
2. <b>C2:</b> Transport<br>
3. <b>D:</b> Réductions<br>
4. <b>POST:</b> Frais postaux<br>
5. <b>M:</b> Ajout manuel<br>
6. <b>BANK CHARGES:</b> Frais bancaire<br>
7. <b>PADS:</b> Frais d'emballage<br>
8. <b>DOT:</b> DOTCOM POSTAGE<br> 
9. <b>UnitPrice < 0</b><br> 
10. <b>Quantity < 0</b><br> 
11. <b>CustomerID = NA</b>
</font size>

## 2. Nettoyage des données
###	b. Nombre de lignes Nettoyées
```{r comment=NA}
cat(nrow(onlineRetail),"lignes à la base")
cat(nrow(onlineRetailClean), "lignes après nettoyage")
cat(nrow(onlineRetailUnique), "lignes après nettoyage et suppression des duplications")
cat("Pourcentage retiré :", 100 - (nrow(onlineRetailUnique)/nrow(onlineRetail)*100), "%")
```

## 3. Statistiques descriptives
### a. Analyse générale
```{r comment=NA}
cat("i. Nombre de pays:",length(unique(onlineRetailUnique$Country)), "(Attention 37 + 'undefined')")
cat("ii. Nombre de factures (uniques):",length(unique(onlineRetailUnique$InvoiceNo)))
cat("iii. Nombre de clients (uniques):",length(unique(onlineRetailUnique$CustomerID)))
cat("iv. Nombre de produits (uniques):",length(unique(onlineRetailUnique$StockCode)))
```


## 3. Statistiques descriptives
### b. Analyse des ventes selon les pays
```{r comment=NA}
pie(slices2, labels = lbls2, main="Pie Chart of Sales")
```

## 3. Statistiques descriptives
### b. Analyse des ventes selon les pays
```{r comment=NA}
pie(slicesNotUK, labels = lblsNotUK, main="Pie Chart of Sales - Out of the UK")
```


## 3. Statistiques descriptives
### b. Analyse des ventes selon les pays
```{r comment=NA}
pie(slicesTopSelling, labels = lblsTopSelling, main="Summary of sales - UK excl.")
```


## 3. Statistiques descriptives
### c. Analyse des ventes
```{r comment=NA}
summary(salesPerProduct$`Sales Product`)
boxplot(salesPerProduct[2], main= "Turnover per product", horizontal = TRUE, outline = FALSE,las=2)
```

## 3. Statistiques descriptives
### c. Analyse des ventes
```{r comment=NA}
summary(invoiceData$`Sales Invoice`)
boxplot(invoiceData[2], main= "Turnover per invoice", horizontal = TRUE, outline = FALSE,las=2)
```

## 3. Statistiques descriptives
### c. Analyse des ventes
#### Factures par mois en 2011
```{r comment=NA}
ggplot(monthData, aes(InvoiceMonth, n)) +  #plot the number of invoices per day               
  geom_bar(stat="identity", fill="steelblue")+
  geom_text(aes(label=n), vjust=1.6, color="white", size=3.5)+
  labs(x="Month", y="Number of invoices")
```

## 3. Statistiques descriptives
### c. Analyse des ventes
#### Factures par jour en 2011
```{r comment=NA}
ggplot(dayData, aes(InvoiceWeekday, n)) +  #plot the number of invoices per day               
  geom_bar(stat="identity", fill="steelblue")+
  geom_text(aes(label=n), vjust=1.6, color="white", size=3.5)+
  labs(x="Week", y="Number of invoices")
```

## 3. Statistiques descriptives
### c. Analyse des ventes
#### Factures par heure du jour en 2011
```{r comment=NA}
ggplot(hourData, aes(InvoiceHour, n)) +  #plot the number of invoices per day               
  geom_bar(stat="identity", fill="steelblue")+
  geom_text(aes(label=n), vjust=1.6, color="white", size=3.5)+
  labs(x="hour", y="Number of invoices")
```

## 3. Statistiques descriptives
### c. Analyse des ventes
#### Chiffre d'affaire par mois
```{r comment=NA}
ggplot(SalesData, aes(InvoiceMonth, CA*turnoverByMonthScale)) +              
  geom_bar(stat="identity", fill="steelblue")+
  geom_text(aes(label=format(round(CA*turnoverByMonthScale, 2), nsmall = 2)), vjust=1.6, color="white", size=3.5)
```


## 4. PCA
### Aggrégation des données avec tous les pays
```{r comment=NA}
pairs(countryData)
```

## 4. PCA
### Aggrégation des données avec tous les pays sauf UK
```{r comment=NA}
pairs(countryDataWithoutUK)
```

## 4. PCA
### Aggrégation des données avec tous les pays sauf UK
#### Matrice des corrélations
```{r comment=NA}
cor(countryDataWithoutUK)
```

## 4. PCA
### Aggrégation des données avec tous les pays sauf UK
#### Sommaire des composants
```{r comment=NA}
summary(pcaCountryWithoutUK)
```

## 4. PCA
### Aggrégation des données avec tous les pays sauf UK
```{r comment=NA}
plot(pcaCountryWithoutUK)
```

## 4. PCA
### Aggrégation des données avec tous les pays sauf UK
#### Poids des variables originales dans les composantes
```{r comment=NA}
loadings(pcaCountryWithoutUK)
```

## 4. PCA
### Aggrégation des données avec tous les pays sauf UK
#### Lien entre les composantes et les variables (axis1)
```{r comment=NA}
score(pcaCountryWithoutUKAde4, xax=1)
```

## 4. PCA
### Aggrégation des données avec tous les pays sauf UK
#### Lien entre les composantes et les variables (axis2)
```{r comment=NA}
score(pcaCountryWithoutUKAde4, xax=2)
```

## 4. PCA
### Aggrégation des données avec tous les pays sauf UK
#### Cercle de corrélation
```{r comment=NA}
s.corcircle(pcaCountryWithoutUKAde4$co)
```

## 4. PCA
### Aggrégation des données avec tous les pays sauf UK
#### Projection des données
```{r comment=NA}
scatter(pcaCountryWithoutUKAde4, posieig="none")
```


## 4. PCA
### Aggrégation de tous les produits
```{r comment=NA}
pairs(productData)
```

## 4. PCA
### Aggrégation de tous les produits
#### Matrice des corrélations
```{r comment=NA}
cor(productData)
```

## 4. PCA
### Aggrégation de tous les produits
#### Sommaire des composants
```{r comment=NA}
summary(pcaProduct)
```

## 4. PCA
### Aggrégation de tous les produits
#### Plot du pca
```{r comment=NA}
plot(pcaProduct)
```

## 4. PCA
### Aggrégation de tous les produits
#### Poids des variables originales dans les composants
```{r comment=NA}
loadings(pcaProduct)
```

## 4. PCA
### Aggrégation de tous les produits
#### Lien entre les composantes et les variables (Axis1)
```{r comment=NA}
score(pcaProductAde4, xax=1)
```


## 4. PCA
### Aggrégation de tous les produits
#### Lien entre les composantes et les variables (Axis2)
```{r comment=NA}
score(pcaProductAde4, xax=2)
```

## 4. PCA
### Aggrégation de tous les produits
#### Cercle de corrélation
```{r comment=NA}
s.corcircle(pcaProductAde4$co)
```

## 4. PCA
### Aggrégation de tous les produits
#### Projection des données
```{r comment=NA}
scatter(pcaProductAde4, posieig = "none", clab.row = 0)
```

## 5.1 Clustering des pays 
### Calcul du nombre de clusters (Elbow Method)
```{r comment=NA}
plot(1:k.max, wssCountries,
     type="b", pch = 19, frame = FALSE, 
     xlab="Number of clusters K",
     ylab="Total within-clusters sum of squares")
abline(v = 4, lty =2)
```

## 5.1 Clustering des pays 
### Table des clusters
```{r comment=NA}
table(countriesClustering.km$cluster)
```

## 5.1 Clustering des pays 
```{r comment=NA}
pairs(countriesClustering[,1:4],col=countriesClustering.km$cluster)
```

## 5.1 Clustering des pays 
### Clusters sur base du PCA
```{r comment=NA}
plot(countriesClusteringWithPCA[,c("Axis1","Axis2")], col="white")
text(countriesClusteringWithPCA[,c("Axis1","Axis2")], labels=rownames(countriesClustering),col=countriesClustering.km$cluster, main="K-means on scaled data",cex=0.50)

```

## 5.2 Clustering des produits
### Calcul du nombre de clusters (Elbow Method)
```{r comment=NA}
wssProducts <- sapply(1:k.max2, 
              function(k){kmeans(productData.CR, k, nstart=50,iter.max = 15 )$tot.withinss})
plot(1:k.max2, wssProducts,
     type="b", pch = 19, frame = FALSE, 
     xlab="Number of clusters K",
     ylab="Total within-clusters sum of squares")
abline(v = 5, lty =2)
```

## 5.2 Clustering des produits
### Table des clusters
```{r comment=NA}
table(productClustering.km$cluster)
```

## 5.2 Clustering des produits 
```{r comment=NA}
pairs(productClusteringWithPCA[,1:5],col=productClustering.km$cluster)
```

## 5.2 Clustering des produits
### Clusters sur base du PCA
```{r comment=NA}
plot(productClusteringWithPCA[,c("Axis1","Axis2")], col="white", main="K-means")
text(productClusteringWithPCA[,c("Axis1","Axis2")], labels=rownames(productClustering), col=productClustering.km$cluster, main="K-means on scaled data", cex=0.50)

```


## 6. Bonus: Wordcloud
```{r fig.align="center"}
set.seed(4363)

wordcloud(names(freq),freq, scale=c(3.5,0.5), max.words=85, min.freq=30, random.order=FALSE, rot.per=0.40, use.r.layout=FALSE, random.color=TRUE, colors=brewer.pal(6,"Dark2"))
```

